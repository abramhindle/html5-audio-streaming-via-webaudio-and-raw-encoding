<html>
<head>
</head>
<body>
<script>
/*
   Apache 2 License (C) 2013 Google, Abram Hindle
*/


window.onload = init;
var context;
var bufferLoader;
var index = 0;
var buffers = [];
var len = 4096;
function init() {
    try {
        // Fix up prefixing
        window.AudioContext = window.AudioContext || window.webkitAudioContext;
        context = new AudioContext();
    } catch (e) {
        alert("WEbaudio"+e);
    }
    try {
        reqSoundRep();
        scriptNodeStream();
        //setInterval(reqSoundRep,(len)/44100 * 1000);
    } catch (e) {
        alert("ScriptNodeStream:" + e);
    }
}

function reqSoundRep() {
    reqSound(index);
}

function reqSound(index) {
    get("http://localhost:3000/stream/?n="+index);
}

function get(url) {
    var request = new XMLHttpRequest();
    request.open("GET", url, true);
    request.responseType = "arraybuffer";
    request.onload = function() {
        try {
            var buff = new Int16Array(request.response);
            buffers.push(buff);
            index++;//= buff.length;
        } catch (e) {
            alert(e);
        };
    };
    request.onerror = function() {
        alert('Didnt get '+url);
    };
    request.send();    
}

function scriptNodeStream() {
    var rate = 44100;
    var node = context.createScriptProcessor(len, 0, 1);
    node.onaudioprocess = function(event) {
        try {
            if (buffers.length > 0) {            
                var buff = buffers.shift();
                event.outputBuffer.getChannelData(0).set(buff);
            } else {
                //alert("Empty");
            }
            reqSoundRep();
        } catch(e) {
            alert(e);
        };
    };
    node.connect(context.destination);    
}

</script>
</body>
</html>
